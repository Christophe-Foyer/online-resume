Function.registerNamespace('cstmUtils.Media');

cstmUtils.Media.YouTubeAPI = "AIzaSyBSbc5Tyfs8T59O-5NSMvWHaYtePDcVocE";  // WUSTL-Engineering


//------------------------------------------------------------------------
// Get the YouTube video ID from URL
//------------------------------------------------------------------------

cstmUtils.Media.GetYouTubeVideoID = function (url) {
    if (url.toLowerCase().indexOf("://www.youtube.com/watch?v=") >= 0) {
        var results = url.match("[\\?&]v=([^&#]*)");
        if (results !== null) {
            return results[1];
        }
    }
    else {
        var pos = url.toLowerCase().indexOf("://youtu.be/");
        if (pos >= 0) {
            return url.substr(pos + 12);
        }
    }
    return "";
};

cstmUtils.Media.GetYouTubePlaylistID = function (url) {
    if (url.toLowerCase().indexOf("://www.youtube.com/playlist?list=") >= 0) {
        var results = url.match("[\\?&]list=([^&#]*)");
        if (results !== null) {
            return results[1];
        }
    }
    return "";
};

//------------------------------------------------------------------------
// Functions for YouTube
//------------------------------------------------------------------------

cstmUtils.Media.GetVideoThumbnailHtml = function (src, vidtitle, addclass) {
    return '<span class="thumb ' + addclass + '">' +
              '<img class="videothumb" src="' + src + '" alt="' + vidtitle + '"/>' +
              '<img class="play" title="play video" src="' + _cstmConst_LayoutsFolder + '/img/btn-play.png" alt=""/>' +
            '</span>' +
            '<span class="title">' + vidtitle + '</span>';
};

cstmUtils.Media.AddVideoPlayIcon = function (theLink) {
    (function ($) {
        $(theLink).append('<img class="play" title="play video" src="' + _cstmConst_LayoutsFolder + '/img/btn-play.png" alt="" />');
    })(jQuery);
};

cstmUtils.Media.GetYouTubeEmbedCode = function (videoID) {
    return cstmUtils.Media.GetYouTubeEmbedCodeWithDimensions(videoID, "448", "100%");
};
cstmUtils.Media.GetYouTubeEmbedCodeWithDimensions = function (videoID, theHeight, theWidth) {
    return '<iframe width="' + theWidth + '" height="' + theHeight + '" src="//www.youtube.com/embed/' + videoID + '?wmode=transparent" frameborder="0" allowfullscreen></iframe>';
};

cstmUtils.Media.FancyboxForYoutube = function (title, urlparams) {
    (function ($) {
        if (urlparams.indexOf("list=") < 0) {
            urlparams += "?autoplay=1&wmode=transparent";
        }
        else {
            urlparams += "&showinfo=1&wmode=transparent";
        }

        $.fancybox({
            'padding': 0,
            'autoScale': true,
            'transitionIn': 'none',
            'transitionOut': 'none',
            'title': title,
            'width': 640,
            'height': 390,
            'href': "//www.youtube.com/embed/" + urlparams,
            'type': 'iframe'
        });
    })(jQuery);
};

// Get Youtube info

cstmUtils.Media.SetYouTubeThumbLinks = function (theLink, videoID) {
    // see https://developers.google.com/youtube/v3/docs/videos/list
    (function ($) {
        var youtubeAPI = 'https://www.googleapis.com/youtube/v3/videos?part=snippet&id=' + videoID + '&key=' + cstmUtils.Media.YouTubeAPI;
        $.ajax({
            dataType: "json",
            url: youtubeAPI,
            error: function (xhr, status, err) {
                var x = status;
            },
            complete: function (response) {
                var items = response.responseJSON.items || [];
                var thumbhtml = "";
                if (typeof (items) == "object" && items.length > 0) {
                    var item = items[0].snippet;
                    var vidtitle = item.title;
                    var src = item.thumbnails.high.url;
                    var desc = item.description.replace(/"/g, '&quot;');
                    thumbhtml = cstmUtils.Media.GetVideoThumbnailHtml(src, vidtitle, "youtube");
                    $(theLink).addClass("video").html(thumbhtml);
                }
                else {
                    $(theLink).html(cstmUtils.Media.GetYouTubeEmbedCodeWithDimensions(videoID, "100%", "100%"));
                }
            }
        });
    })(jQuery);
};

cstmUtils.Media.SetYouTubeThumbLinksV2API = function (theLink, videoID) {
    // The YouTube Data API (v2) has been officially deprecated as of March 4, 2014 
    // (see https://developers.google.com/youtube/2.0/developers_guide_protocol_audience).
    // see https://developers.google.com/youtube/2.0/reference#youtube_data_api_tag_media:thumbnail
    // See http://stackoverflow.com/questions/6560311/how-to-get-a-youtube-playlist-using-javascript-api-and-json
    // See http://code.google.com/p/gdata-samples/source/browse/trunk/ytplayer/stb-web-app/static/javascript/index.js?r=238

    (function ($) {
        var youtubeAPI = 'https://gdata.youtube.com/feeds/api/videos/' + videoID + '?v=2&alt=jsonc&callback=?';
        $.getJSON(youtubeAPI, function (response) {
            var item = response.data || [];
            if (typeof (item) == "object") {
                var vidtitle = item.title;
                var desc = item.description.replace(/"/g, '&quot;');
                var thumbhtml = cstmUtils.Media.GetVideoThumbnailHtml(item.thumbnail.hqDefault, vidtitle, "youtube");
                $(theLink).addClass("video").html(thumbhtml);
            }
        });
    })(jQuery);
};

//TODO: GetYouTubePlaylist* functions need to be upgraded to YouTube API v3 if they're ever used
cstmUtils.Media.GetYouTubePlaylist = function (listID, container, getmqthumb, clickHandler) {
    // https://developers.google.com/youtube/2.0/developers_guide_jsonc#Playlist
    // https://developers.google.com/youtube/articles/view_youtube_jsonc_responses
    // see https://developers.google.com/youtube/js_api_reference#Retrieving_playlist_information
    // see https://groups.google.com/forum/?fromgroups=#!topic/youtube-api-gdata/7TseRB4jLIw
    // For IE, needed to add "&callback=?" to the URL (see http://stackoverflow.com/questions/6514457/getjson-or-ajax-requests-not-working-with-ie9)

    (function ($) {
        var getmq = (typeof (getmqthumb) === "boolean" && getmqthumb);
        var youtubeAPI = 'https://gdata.youtube.com/feeds/api/playlists/' + listID + '?v=2&alt=jsonc&callback=?';

        $.getJSON(youtubeAPI, function (response) {

            var items = response.data.items || [];
            for (i = 0; i < items.length; i++) {
                var item = items[i];
                var itemID = item["video"]["id"];
                var vidtitle = item["video"]["title"];
                var desc = item["video"]["description"];

                var thumb = item["video"]["thumbnail"]["hqDefault"];
                if (getmq) {
                    thumb = thumb.replace("hqdefault", "mqdefault");
                }
                var thumbHtml = cstmUtils.Media.GetVideoThumbnailHtml(thumb, vidtitle, "youtube");

                var url = item["video"]["player"]["default"];  // "https://www.youtube.com/watch?..."
                var rel = itemID + "?list=" + listID;
                //var rel = itemID + "?showinfo=1&amp;autoplay=1&amp;list=" + listID + "&amp;index=" + (i+1);
                var obj = $('<div><a class="video" rel="' + rel + '" href="' + url + '" title="' + desc.replace(/"/g, '&quot;') + '">' + thumbHtml + '</a></div>');
                if (typeof (clickHandler) === "function") {
                    $(obj).find("a.video").click(function (e) {
                        e.preventDefault();
                        clickHandler($(this));
                    });
                }
                $(container).append(obj);
            }
        });
    })(jQuery);
};


//TODO: GetYouTubePlaylist* functions need to be upgraded to YouTube API v3 if they're ever used
// Get single thumb link for playlist
cstmUtils.Media.GetYouTubePlaylistPlayerThumb = function (listID, anchor, clickHandler, afterLoadHandler) {

    (function ($) {
        var youtubeAPI = 'https://gdata.youtube.com/feeds/api/playlists/' + listID + '?v=2&alt=jsonc&callback=?';
        $.getJSON(youtubeAPI, function (response) {

            var items = response.data.items || [];
            if (items.length > 0) {
                var item = items[0];
                var rel = item["video"]["id"] + "?list=" + listID;
                //var rel = item["video"]["id"] + "?showinfo=1&amp;list=" + listID + "&amp;index=1";
                var thumbHtml = cstmUtils.Media.GetVideoThumbnailHtml(response.data.thumbnail.hqDefault, response.data.title, "youtube");

                var obj = $('<div><a class="video" rel="' + rel + '" href="http://www.youtube.com/playlist?list=' + listID + '">' + thumbHtml + '</a>' +
                            '<div class="vidinfo">' + response.data.description + ' <span class="stats">' + response.data.totalItems + ' videos</span></div></div>');

                if (typeof (clickHandler) === "function") {
                    $(obj).find("a.video").click(function (e) {
                        e.preventDefault();
                        clickHandler($(this));
                    });
                }

                if (typeof (afterLoadHandler) === "function") {
                    afterLoadHandler($(this));
                }

                if (typeof (anchor) === "object") {
                    $(anchor).replaceWith(obj);
                    _cstmFunc_SetHeightFromWidth($(obj).find(".video .thumb"));
                }

            }
        });
    })(jQuery);
};

cstmUtils.Media.GetYouTubePlayer = function (listID, anchor, player, showPlayer, afterLoadHandler) {
    (function ($) {
        var youtubeAPI = 'https://gdata.youtube.com/feeds/api/playlists/' + listID + '?v=2&alt=jsonc&callback=?';
        $.getJSON(youtubeAPI, function (response) {
            var obj = $('<div><h4><a href="http://www.youtube.com/playlist?list=' + listID + '">' + response.data.title + '</a></h4><p class="vidinfo">' + response.data.description + '</p></div>');
            if (showPlayer) {
                // Put player markup
                $(player).html('<iframe width="100%" height="448" src="http://www.youtube.com/embed/videoseries?list=' + listID + '&amp;hl=en_US&amp;showinfo=1&amp;wmode=transparent" frameborder="0"  allowfullscreen></iframe>');
                $(player).append(obj);
            }
            else if (typeof (anchor) === "object") {
                $(obj).find("p.vidinfo").append('<a class="callout" href="http://www.youtube.com/playlist?list=' + listID + '"><span class="hasvideo">View Playlist</span></a>');
                $(anchor).replaceWith(obj);
            }

            $(obj).find("a").click(function (e) {
                e.preventDefault();
                cstmUtils.Media.GetYouTubePlayer(listID, null, player, true);

                // Move view up to player element
                var playerID = $(player).attr("id");
                if (typeof (playerID) !== "string") {
                    playerID = "";
                }
                location.hash = playerID;
            });

            if (typeof (afterLoadHandler) === "function") {
                afterLoadHandler($(this));
            }

        });
    })(jQuery);
};
